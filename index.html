<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="description" content="Calcite Maps Demo - ArcGIS">
  <link rel="icon" href="http://www.esri.com/favicon.ico">
  <title>PeliTrack v2.0</title>

  <!-- Calcite Bootstrap -->
  <link rel="stylesheet" href="dist/css/calcite-bootstrap.min-v0.2.css">

  <!-- Calcite Maps -->
  <link rel="stylesheet" href="dist/css/calcite-maps-arcgis-4.x.min-v0.2.css">

  <!-- ArcGIS JS 4.0 -->
  <link rel="stylesheet" href="http://js.arcgis.com/4.0/esri/css/main.css">

    <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <!-- jQuery (for Bootstrap's JavaScript plugins). NOTE: You can also use pure Dojo. See examples. -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Include all  plugins or individual files as needed -->
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="dist/js/datepicker/daterangepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
    <script type="text/javascript" src="dist/js/bootstrap_multiselect/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" href="dist/css/bootstrap_multiselect/bootstrap-multiselect.css" type="text/css"/>


  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <!--script src="../../assets/js/ie10-viewport-bug-workaround.js"></script-->

  <!-- Calcite Maps -->
  <script src="dist/js/jquery/calcitemaps-v0.2.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
        height:100%;
    }
    .esri-legend{
        max-width: 30px;
        background-color: #333333;
        color: white;
        border: 1px solid #4c4c4c;
    }
      @media screen and (max-width: 768px) {
    .esri-legend {
        display: none;
    }
}
.forceLegend{
    display:block !important;
}
    .esri-ui-top-left{
          z-index: 0;
      }
  #load {
      position:absolute;
      z-index: 5;
      top: 40%;
      left:50%;
  }
  </style>

</head>

<body class="calcite-nav-bottom">
    <div class = "hidden" id = "load"><img src="load.gif" class="img-fluid" alt="Loading..." style = "heigh:32px; width:32px;"></div>
  <!-- Navbar -->

  <nav class="navbar calcite-navbar navbar-fixed-bottom calcite-text-light calcite-bg-dark calcite-black-75 dropup">
    <!-- Header -->
    <div class="navbar-header">
      <a class="navbar-brand"><img src="pelican_fly.png" class="img-fluid" alt="Flying pelican"></a>
    </div>
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
      <div class="calcite-title-main">PeliTrack v2.0</div>
      <div class="calcite-title-sub">Utah Division of Wildlife Resources</div>
    </div>
     <!-- Nav -->
    <ul class="nav navbar-nav">
        <li id = "filterNav2" style ="cursor:pointer;"><a id ="filterNav" class="toggle " role ="tab" title="Tools" data-tooltip="tip" data-placement="bottom">
            <span class="glyphicon glyphicon-cog"></span><span class="hidden-xs hidden-sm">  Tools</span>
        </a></li>
        <li id = "legendNav" class = "active" style="cursor:pointer;"><a id="legendNav2" aria-controls="2Dtab" aria-expanded="true" role="tab"  data-tooltip="tip" title="Toggle Legend" data-placement="bottom"><span class="glyphicon glyphicon-th-list"></span><span class="hidden-xs hidden-sm"> Toggle Legend</span> </a></li>
      <li id ="basemapNav2" style="cursor:pointer;"><a id="basemapNav" aria-controls="BasemapTab" role="tab" class="toggle" data-tooltip="tip" title="Change Basemap" data-placement="bottom"><span class="glyphicon glyphicon-th-large"></span><span class="hidden-xs hidden-sm">  Change Basemap</span></a>
      </li>
    </ul>



  </nav><!--/.navbar -->



  <!-- Map Container  -->

  <div class="calcite-map calcite-map-absolute calcite-overflow-hidden">
    <div id="tabContainer" class="tab-content">
      <div id="2dTab" class="tab-pane fade in active" role="tabpanel">
         <div id ="filtercont" class="container-fluid hidden " style="width:100%;">
            <div class="row">
                <div id="filter-panel" class="filter-panel calcite-text-light calcite-bg-dark calcite-black-75" style="position:absolute;bottom:65px;z-index:1; width:100%; display:inline-block;text-align:center">
                    <div class="panel panel-default">
                        <div class="panel-body" style = "background-color:#333333; color: white;">
                            <form class="form-inline" role="form" style="padding-top:20px;">
                                <div class="form-group">
                                    <label class="filter-col" for="nameselect">Filter by Name: </label>
                                    <select id="nameselect" class="form-control input-sm" multiple="multiple">
                                        <option value="Abigail">Abigail</option>
                                        <option value="Annabelle">Annabelle</option>
                                        <option value="Barnabus">Barnabus</option>
                                        <option value="Bartholomew">Bartholomew</option>
                                        <option value="Cecilia">Cecilia</option>
                                        <option value="Chester">Chester</option>
                                        <option value="Daphne">Daphne</option>
                                        <option value="Derek">Derek</option>
                                        <option value="Eleanor">Eleanor</option>
                                        <option value="Everett">Everett</option>
                                        <option value="Finnigan">Finnigan</option>
                                        <option value="Flagg">Finnigan</option>
                                        <option value="George">George</option>
                                        <option value="Gerald">Gerald</option>
                                        <option value="Hector">Hector</option>
                                        <option value="Indie">Indie</option>

                                    </select>
                                </div> <!-- form group [rows] -->
                                <div class="form-group">
                                    <label class="filter-col" for="daterange">Filter by Date: </label>
                                    <input type="button" class="form-control input-sm" id="daterange" value="Most Recent Points Shown">
                                </div><!-- form group [search] -->
                                <div class="form-group">
                                    <button id ='applyBtn' type="button" class="btn btn-default filter-col">
                                        <span class="glyphicon glyphicon-record"></span>    Apply
                                    </button>
                                    <button id = 'resetBtn' type="button" class="btn btn-default filter-col">
                                        <span class="glyphicon glyphicon-record"></span>    Reset Filters
                                    </button>
                                    <div class="checkbox" style="margin-left:20px;">
                                        <label><input type="checkbox" id = "togglePts"> Show Data Points</label>
                                    </div>
                                    <div class="checkbox" style="margin-left:20px;">
                                        <label><input type="checkbox" id = "toggleHeat"> Toggle Heatmap</label>
                                    </div>
                                    <div class="checkbox" style="margin-left:20px;">
                                        <label><input type="checkbox" id = "toggleColony"> Toggle Colony Layer</label>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                </div>
             </div>
          <div id="mapViewDiv"></div>
      </div>
      <div id="3dTab" class="tab-pane fade" role="tabpanel">
        <div id="sceneViewDiv"></div>
      </div>
    </div>
  </div>

  <!-- Panel Container -->
<div class="calcite-panels calcite-text-light calcite-bg-dark calcite-black-75 panel-group" role="tablist" aria-multiselectable="true" style="z-index:2;">
    <div id="panelBasemaps" class="panel hidden">
      <div id="headingBasemaps" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle collapsed" role="button" data-toggle="collapse" href="#collapseBasemaps" aria-expanded="false"   aria-controls="collapseBasemaps"><span class="glyphicon glyphicon-th-large" aria-hidden="true"></span> Basemaps</a>
          <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelBasemaps"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>
        </div>
      </div>
      <div id="collapseBasemaps" class="panel" role="tabpanel" aria-labelledby="headingBasemaps">
        <div class="panel-body">
          <select id="selectBasemapPanel" class="form-control" style="background-color:white;color:black">
            <option value="satellite" data-vector="satellite" >Imagery</option>
            <option value="hybrid" data-vector="hybrid">Imagery with Labels</option>
            <option value="national-geographic" data-vector="national-geographic">National Geographic</option>
            <option value="topo" data-vector="topo-vector">Topographic</option>
            <option value="dark-gray" data-vector="dark-gray-vector" selected="">Dark Gray</option>
          </select>
        </div>
      </div>
    </div>
  </div> <!-- /.calcite-panels -->

  <!-- ArcGIS JS 4.0 -->
  <script src="http://js.arcgis.com/4.0/"></script>

  <script>
      var app;
    var startDate;
    var endDate;
    var names_all = ["Abigail","Annabelle","Barnabus","Bartholomew","Cecilia","Chester","Daphne","Derek","Eleanor","Everett","Flagg","George","Gerald","Hector","Indie","Jerome"];
      var name_colors = [
                    [166, 206, 227],
                    [31, 120, 180],
                    [178, 223, 138],
                    [51, 160, 44],
                    [251, 154, 153],
                    [227, 26, 28],
                    [253, 191, 111],
                    [255, 127, 0],
                    [202, 178, 214],
                    [106, 61, 154],
                    [255, 255, 153],
                    [177, 89, 40],
                    [86, 90, 153],
                    [204, 80, 25],
                    [117, 255, 0],
                    [237, 142, 255],
                    [123, 178, 151],
                    [255, 236, 191],
                    [238, 211, 255],
                    [203, 54, 126],
                    [102, 202, 234],
                    [230, 120, 120],
                    [102, 189, 202],
                    [95, 95, 215],
                    [175, 65, 175],
                    [250, 165, 105],
                    [120, 120, 120],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0],
					[0, 255, 0]

                ];

                var nameColor = [];
				var dict = {};
                for (var n = 0; n < names_all.length; n++) {
                    dict[names_all[n]] = name_colors[n]
					var tL = [];
                    tL.push(names_all[n]);
                    tL.push(name_colors[n]);
                    nameColor.push(tL);
                }

    require(["esri/Map",
      "esri/Basemap",
        "esri/widgets/Home",
            "esri/widgets/Compass",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/widgets/Search",
        "esri/layers/FeatureLayer",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/widgets/Popup",
		"esri/PopupTemplate",
            "esri/geometry/Polyline","esri/geometry/Point",
            "esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol",
            "esri/widgets/Legend",
            "esri/renderers/UniqueValueRenderer",
      "esri/core/watchUtils",
      "dojo/query",
      "dojo/domReady!"
    ], function(Map, Basemap, Home, Compass, MapView, SceneView, Search,FeatureLayer,GraphicsLayer, Graphic, Popup, PopupTemplate,Polyline,Point,SimpleLineSymbol,SimpleMarkerSymbol, Legend, UniqueValueRenderer, watchUtils, query) {

        // App
        app = {
            scale: 50000000,
            center: [-111.95, 39.419],
            zoom: 5,
            initialExtent: null,
            basemap: "dark-gray",
            viewPadding: {
                bottom: 65
            },
            uiPadding: {
                top: 30, bottom: 15
            },
            mapView: null,
            sceneView: null,
            activeView: null,
            searchWidgetNav: null
        };
        // Map
        var map = new Map({
            basemap: app.basemap
        });

        app.mapView = new MapView({
            container: "mapViewDiv",
            map: map,
            zoom: app.zoom,
            center: app.center,
            padding: app.viewPadding,
            ui: {
                components: ["zoom"],
                padding: app.uiPadding
            },
            popup:{
                dockEnabled: true,
                dockOptions: {
                    buttonEnabled: true,
                    breakpoint:true,
                    position: 'top-center'
                }
            }
        });
        var homeBtn = new Home({
            view: app.mapView
        });
        var compass = new Compass({
            view: app.mapView
        });

        app.mapView.ui.add(homeBtn, "top-left");
        app.mapView.ui.add(compass, "top-left");
          var rendererPts = new UniqueValueRenderer({
          field: "name"
          //defaultSymbol: new SimpleFillSymbol()
        });
        var rendererPtsMRP = new UniqueValueRenderer({
          field: "name"
          //defaultSymbol: new SimpleFillSymbol()
        });
        var rendererLns = new UniqueValueRenderer({
          field: "name"
          //defaultSymbol: new SimpleFillSymbol()
        });
         for (i in dict){
            rendererPts.addUniqueValueInfo(i,
            new SimpleMarkerSymbol({
                color: dict[i],
                size: '6px'
            })
            );
             rendererPtsMRP.addUniqueValueInfo(i,
            new SimpleMarkerSymbol({
                color: dict[i],
                size: '12px'
            })
            );
             rendererLns.addUniqueValueInfo(i,
            new SimpleLineSymbol({
                color: dict[i],
                width: 1
            })
            );
        }
        var template = new PopupTemplate({
        title: "{name}",
        content: "Seen here on {Date_time}",
        fieldInfos: [{
			fieldName: "Date_time",
			label: "Date",
			format:{
                dateFormat: 'short-date-short-time'
            }
		  }, {
			fieldName: "name",
			label: "Name",
			visible: true
		  }
		  ]
		  });
        var colonyTemplate = new PopupTemplate({
        title: "{COLONY}",
        content: "Colony Name: {COLONY}<br>Population: {pop}",
        fieldInfos: [{
			fieldName: "COLONY",
			label: "Colony Name"
		  }, {
			fieldName: "pop",
			label: "Population",
			visible: true
		  }
		  ]
		  });

        //console.log(app.mapView.popup.ViewModel);
        var graphicA = new Graphic();
        var gLayer = new GraphicsLayer({
            graphics: [graphicA]
            });
        var legendLayer = new FeatureLayer({
            url: 'https://services.arcgis.com/ZzrwjTRez6FJiOq4/arcgis/rest/services/Tracked_Pelicans/FeatureServer',
            renderer: rendererPtsMRP
            });
        var gLayerMRP = new GraphicsLayer({
            popupTemplate: template
        });
        var mrp = new FeatureLayer ({
            url: 'http://maps.dnr.utah.gov:6080/arcgis/rest/services/DWR/AWPE_Argos_Data/MapServer/1',
            outFields: ["*"],
            popupTemplate: template,
            renderer: rendererPtsMRP
        });
        var fl = new FeatureLayer({
            url: "http://maps.dnr.utah.gov:6080/arcgis/rest/services/DWR/AWPE_Argos_Data/MapServer/0",
            outFields: ["*"],
            popupTemplate: template,
            renderer: rendererPts

        });
        var colonies = new FeatureLayer({
            url: "http://services.arcgis.com/ZzrwjTRez6FJiOq4/arcgis/rest/services/Western_Breeding_Colonies/FeatureServer/0",
            outFields: ["*"],
            popupTemplate: colonyTemplate
        });
        fl.load();



        map.add(colonies);
        map.add(legendLayer);
        map.add(mrp);

        var legend = new Legend({
            view: app.mapView,
            layerInfos: [{
                layer: legendLayer,
                title: "Tracked Pelicans"
                },{
                layer: colonies,
                title: "Breeding Colonies"
            }]
         });
        legend.startup();
        app.mapView.ui.add(legend, "bottom-left");
        // Scene
        var mapScene = new Map({
            basemap: app.basemap,
            ground: "world-elevation"
        });
        app.sceneView = new SceneView({
            container: "sceneViewDiv",
            map: mapScene,
            scale: app.scale,
            center: app.center,
            padding: app.viewPadding,
            ui: {
                padding: app.uiPadding
            }
        });
        app.activeView = app.mapView;
        app.activeView.then(function () {
            app.initialExtent = app.activeView.extent;
        });
        // Search



        app.searchWidgetNav = createSearchWidget("searchNavDiv");
        function createSearchWidget(parentId) {
            var search = new Search({
                viewModel: {
                    view: app.activeView,
                    highlightEnabled: false,
                    popupEnabled: true,
                    showPopupOnSelect: true
                }
            }, parentId);
            search.startup();
            return search;
        }

        // Popup Events
        app.mapView.popup.watch("currentDockPosition", function (result) {
            setPanelVisibility();
        });
        app.sceneView.popup.watch("currentDockPosition", function (result) {
            setPanelVisibility();
        });


        // Panel Events
        query(".calcite-panels .panel").on("show.bs.collapse", function (e) {
            if (app.activeView.popup.currentDockPosition) {
                app.activeView.popup.dockEnabled = false;
            }
        });
        // Window Events
        query(window).on("resize", function () {
            setPanelVisibility();
        })
        // Panel show/hide
        function setPanelVisibility() {
            if (app.activeView.popup.visible && app.activeView.popup.currentDockPosition && !(window.innerWidth > 544 && window.innerWidth < 768)) {
                if (query(".calcite-panels .panel.in").length > 0) {
                    query(".calcite-panels").addClass("invisible");
                } else {
                    query(".calcite-panels").removeClass("invisible");
                }
            } else {
                query(".calcite-panels").removeClass("invisible");
            }
        }

        // Tab Events (Views)
        query(".calcite-navbar li a[data-toggle='tab']").on("click", function (e) {
            syncTabs(e);
            if (e.target.text.indexOf("Map") > -1) {
                syncViews(app.sceneView, app.mapView);
                app.activeView = app.mapView;
            } else {
                syncViews(app.mapView, app.sceneView);
                app.activeView = app.sceneView;
            }
            syncSearch();
        });
        // Tab
        function syncTabs(e) {
            query(".calcite-navbar li.active").removeClass("active");
            query(e.target).addClass("active");
        }

        // View
        function syncViews(fromView, toView) {
            watchUtils.whenTrueOnce(toView, "ready").then(function (result) {
                watchUtils.whenTrueOnce(toView, "stationary").then(function (result) {
                    toView.goTo(fromView.viewpoint);
                    toView.popup.reposition();
                });
            });
        }

        // Search
        function syncSearch() {
            app.searchWidgetNav.viewModel.view = app.activeView;
            // Sync
            if (app.searchWidgetNav.selectedResult) {
                app.searchWidgetNav.search(app.searchWidgetNav.selectedResult.name);
            }
            app.activeView.popup.reposition();
        }

        // Basemap events
        query("#selectBasemapPanel").on("change", function (e) {
            app.mapView.map.basemap = e.target.value;
        });
        // Collapsible popup (optional)
        query(".esri-popup .esri-title").on("click", function (e) {
            query(".esri-popup .esri-container").toggleClass("esri-popup-collapsed");
            app.activeView.popup.reposition();
        });
        // Home
        query(".calcite-navbar .navbar-brand").on("click", function (e) {
            app.activeView.goTo({target: app.initialExtent, rotation: 0});
        })


        $('#togglePts').click(function(){
            if($(this).is(':checked')&& typeof startDate !== "undefined"){
                    map.add(fl);
                    map.add(gLayerMRP);

            }
                    else if ($(this).is(':checked')&& typeof startDate == "undefined"){
                $('#togglePts').attr('checked', false);
            }
            else {
                map.remove(fl);
            }
        });

        $('#resetBtn').click(function (event) {
            event.preventDefault();
            $('#daterange').val('Most Recent Points Shown');
            $('#nameselect').multiselect("selectAll", false);
            $('#nameselect').multiselect('refresh');
            $('#togglePts').attr('checked', false);
            map.remove(fl);
            map.add(mrp);
            gLayer.removeAll();
            gLayerMRP.removeAll();
        });

        $('.panel-close').click(function (event) {
            event.preventDefault();
            $('#panelBasemaps').toggleClass('hidden show');
            $('#basemapNav2').toggleClass('active');

        });

        $('li#filterNav2').click(function (event) {
            event.preventDefault();
            $('#filtercont').toggleClass('hidden show');
            $('#filterNav2').toggleClass('active');
        });
        $('li#basemapNav2').click(function (event) {
            event.preventDefault();
            $('#panelBasemaps').toggleClass('hidden show');
            $('#basemapNav2').toggleClass('active');
        });
        $('li#legendNav').click(function (event) {
            event.preventDefault();
            $('.esri-legend').toggleClass('hidden show');
            //console.log(screen.width);
            if ((screen.width<768)) {
                console.log("screen small");
                // if screen size is 1025px wide or larger
            $('.esri-legend').toggleClass('forceLegend');
            }

            $('#legendNav').toggleClass('active');
        });

    $(
            document).ready(function() {

        $('#daterange').keypress(function(e) {
            if(e.which == 13) { // Checks for the enter key
                e.preventDefault();
                $("#applyBtn").click();
    }});
        $('#nameselect').multiselect({
            includeSelectAllOption: true,
            maxHeight: 200, dropUp:true
        });
        $("#nameselect").multiselect('selectAll', false);
        $("#nameselect").multiselect('updateButtonText');

        function cb(start, end) {
        $('#daterange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }
    cb(moment().subtract(29, 'days'), moment());

    $('#daterange').daterangepicker({
        "startDate": moment().subtract(6, 'days'),
        "endDate": moment(),
        "autoApply":true,
        autoUpdateInput: false,
        locale: {
          cancelLabel: 'Clear'
      },
        ranges: {
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
            'Last Year': [moment().subtract(1, 'year'), moment()]
        },
        "drops":"up",
        "opens":"center"
    },
        function(start, end, label) {
            console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label);
                startDate = start;
                endDate = end;
        }
    );

        /* $('#daterange').daterangepicker({
     autoUpdateInput: false,
            locale: {
          cancelLabel: 'Clear'
      },
            "showDropdowns": true,
    "timePicker": true,
    "autoApply": true,
    "ranges": {
        "Last 7 Days": [
            week,
            today
        ],
        "Last 30 Days": [
            month,
            today
        ],
        "Last Year": [
            year,
            today
        ],
        "Last Southern Migration": [
            new Date().setDate(today.getDate()-180),
            today
        ],
        "Last Northern Migration": [
            new Date().setDate(today.getDate()-365),
                today
        ]
    },
    "opens": "right",
            "drops":"up"
}, function(start, end, label) {
  console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label);
});*/
         function isInArray(value, array) {
            return array.indexOf(value) > -1;
            }

        $('#applyBtn').click(function (event) {
            $('#load').toggleClass('hidden show');
            event.preventDefault();
            gLayer.removeAll();
            gLayerMRP.removeAll();
            map.remove(mrp);

            var selected = $('#nameselect option:selected').map(function (a, item) {
                return item.value;
            });
            if (selected.length > 0) {
                var nameListStr = "name IN (";
                for (var i = 0; i < selected.length; i++) {
                    if (i < selected.length - 1) {
                        nameListStr = nameListStr + "'" + selected[i] + "',";
                    }
                    else {
                        nameListStr = nameListStr + "'" + selected[i] + "')";
                    }
                }
            }
            else{
                nameListStr = "";
            }
            var dQuery;
            //console.log(startDate);
            if (typeof startDate !== "undefined") {
                var sDate = startDate.format('MM-DD-YYYY');
                var eDate = endDate.format('MM-DD-YYYY');
                dQuery = "Date_time <= date'"+eDate+"' AND Date_time >= date'"+sDate+"'";
            }
            else {
                dQuery = ""
            }
            if (nameListStr == ""){
                var query = dQuery
            }
            else{
                var query = dQuery + " AND "+ nameListStr;
            }
            //console.log(nameListStr);
            //var query = "ptt_id IN "+nameListStr;

            console.log(query);
            //dQuery = "Date_time <= date'06-16-2016' AND Date_time >= date'05-01-2016'";
            //console.log(dQuery);
            fl.definitionExpression = query;
            fl.queryFeatures().then(function(results){
              // prints the array of result graphics to the console

                var ptt_list = [];
                var geom = results.features;
                geom.forEach(function(i){
                    var x = i.attributes.name;
                        if (!isInArray(x,ptt_list)){
                            ptt_list.push(x);
                            }
                });

                var ptList = [];
                for (var i = 0; i < ptt_list.length; i++) {
                    var latLngArray = [];

                    var ptList2 = [];
                    geom.forEach(function (arrayItem) {
                        if (arrayItem.attributes.name == ptt_list[i]) {
                            ptList2.push(arrayItem);
                                var coords = [];
                                coords.push(arrayItem.geometry.longitude);
                                coords.push(arrayItem.geometry.latitude);
                                latLngArray.push(coords);

                        }

                    });
                     ptList2.sort(function(a, b) {
                        return parseFloat(a.attributes.Date_time) - parseFloat(b.attributes.Date_time);
                    });
                    ptList.push(ptList2);
                    }





                    console.log("ListL",ptList.length);
                    for (var x = 0; x < ptList.length;x++) {
                        var coordinates =[];
                        var name = ptList[x][0].attributes.name;
                        for(var y=0; y < ptList[x].length;y++){
                            /*if (y=  ptList[x].length-1){
                                ///////////////////////
//                                var ll = [];
//                                var c = [];
//                            c.push(ptList[x][y].geometry.longitude);
//                            c.push(ptList[x][y].geometry.latitude);
//                            ll.push(coords);
                            var ptAtt = {
                                name: name,
                            };
                                var mrpPt = new Point({
                                    latitude:ptList[x][y].geometry.latitude,
                                    longitude: ptList[x][y].geometry.longitude,
                                });
                                var mrpGraphic = new Graphic({
                                geometry: mrpPt,
                                symbol: new SimpleMarkerSymbol({
                                        color: dict[name],
                                        size: '12px'
                                        }),
                                attributes: ptAtt
                            });

                            gLayerMRP.add(mrpGraphic);
                                //////////////////////////
                            }*/
                            var coordTemp = [];
                            coordTemp.push(ptList[x][y].geometry.longitude);
                            coordTemp.push(ptList[x][y].geometry.latitude);
                            coordinates.push(coordTemp);
                        }
                        var endIndex = ptList[x].length -1;
                        var date1 = ptList[x][endIndex].attributes.Date_time;
                        var ptAtt = {
                                name: name,
                                Date_time: date1
                            };
                                var mrpPt = new Point({
                                    latitude:ptList[x][endIndex].geometry.latitude,
                                    longitude: ptList[x][endIndex].geometry.longitude,
                                });
                                var mrpGraphic = new Graphic({
                                geometry: mrpPt,
                                symbol: new SimpleMarkerSymbol({
                                        color: dict[name],
                                        size: '12px'
                                        }),
                                attributes: ptAtt
                            });

                            gLayerMRP.add(mrpGraphic);

                        var pl = new Polyline({
                            paths: coordinates
                        });
                        var lineAtt = {
                        name: name
                      };
                         var lineSymbol = new SimpleLineSymbol({
                        color: dict[name],
                        width: "1.5px"
                    });
                        var plGraphic = new Graphic({
                        geometry: pl,
                        symbol: lineSymbol,
                        attributes: lineAtt
                    });
                        gLayer.add(plGraphic);
                    }
                    //console.log(latLngArray);



            $('#load').toggleClass('hidden show');
            });
            //map.add(fl);
            map.add(gLayer);
            map.add(gLayerMRP);
        });

        $(function() {
  $('#daterange').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format(
                      'MM/DD/YYYY') + ' - ' + picker.endDate.format(
                      'MM/DD/YYYY'));
  });

  $('#daterange').on('cancel.daterangepicker',
          function(ev, picker) {
      $(this).val('');
  });

});
        var drp = $('#daterange').data(
                'daterangepicker');
          console.log(drp.startDate_d);
    });
    app.mapView.watch("updating", function(val) {
        if (val == 'loaded'){
            //hide gif
            $('#load').toggleClass('hidden show');
        }
        else{
            //show gif
            $('#load').toggleClass('hidden show');
        }
    });// wait for the layer view to finish updating

});

  </script>



</body>
</html>