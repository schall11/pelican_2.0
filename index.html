<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="description" content="Calcite Maps Demo - ArcGIS">
  <link rel="icon" href="http://www.esri.com/favicon.ico">
  <title>PeliTrack v2.0</title>

  <!-- Calcite Bootstrap -->
  <link rel="stylesheet" href="dist/css/calcite-bootstrap.min-v0.2.css">

  <!-- Calcite Maps -->
  <link rel="stylesheet" href="dist/css/calcite-maps-arcgis-4.x.min-v0.2.css">

  <!-- ArcGIS JS 4.0 -->
  <link rel="stylesheet" href="http://js.arcgis.com/4.0/esri/css/main.css">

    <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <!-- jQuery (for Bootstrap's JavaScript plugins). NOTE: You can also use pure Dojo. See examples. -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Include all  plugins or individual files as needed -->
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="dist/js/datepicker/daterangepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
    <script type="text/javascript" src="dist/js/bootstrap_multiselect/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" href="dist/css/bootstrap_multiselect/bootstrap-multiselect.css" type="text/css"/>


  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <!--script src="../../assets/js/ie10-viewport-bug-workaround.js"></script-->

  <!-- Calcite Maps -->
  <script src="dist/js/jquery/calcitemaps-v0.2.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    .esri-legend{
        max-width: 30px;
        background-color: #333333;
        color: white;
        border: 1px solid #4c4c4c;
    }

  </style>

</head>

<body class="calcite-nav-bottom">

  <!-- Navbar -->

  <nav class="navbar calcite-navbar navbar-fixed-bottom calcite-text-light calcite-bg-dark calcite-black-75 dropup">
    <!-- Header -->
    <div class="navbar-header">
      <a class="navbar-brand"><span class="esri-icon esri-icon-map-pin"></span></a>
    </div>
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
      <div class="calcite-title-main">PeliTrack v2.0</div>
      <div class="calcite-title-sub">Utah Division of Wildlife Resources</div>
    </div>
     <!-- Nav -->
    <ul class="nav navbar-nav">
        <li id = "filterNav2" style ="cursor:pointer;"><a id ="filterNav" class="toggle " role ="tab" title="Filter Data" data-tooltip="tip" data-placement="bottom">
            <span class="glyphicon glyphicon-cog"></span><span class="hidden-xs hidden-sm">  Filter Data</span>
        </a></li>
        <li id = "legendNav" style="cursor:pointer;"><a id="legendNav2" aria-controls="2Dtab" aria-expanded="true" role="tab"  data-tooltip="tip" title="Toggle Legend" data-placement="bottom"><span class="glyphicon glyphicon-th-list"></span><span class="hidden-xs hidden-sm"> Toggle Legend</span> </a></li>
      <li id ="basemapNav2" style="cursor:pointer;"><a id="basemapNav" aria-controls="BasemapTab" role="tab" class="toggle" data-tooltip="tip" title="Change Basemap" data-placement="bottom"><span class="glyphicon glyphicon-th-large"></span><span class="hidden-xs hidden-sm">  Change Basemap</span></a>
      </li>
    </ul>



  </nav><!--/.navbar -->



  <!-- Map Container  -->

  <div class="calcite-map calcite-map-absolute calcite-overflow-hidden">
    <div id="tabContainer" class="tab-content">
      <div id="2dTab" class="tab-pane fade in active" role="tabpanel">
         <div id ="filtercont" class="container-fluid hidden " style="width:100%;">
            <div class="row">
                <div id="filter-panel" class="filter-panel calcite-text-light calcite-bg-dark calcite-black-75" style="position:absolute;bottom:65px;z-index:1; width:100%; display:inline-block;text-align:center">
                    <div class="panel panel-default">
                        <div class="panel-body" style = "background-color:#333333; color: white;">
                            <form class="form-inline" role="form" style="padding-top:20px;">
                                <div class="form-group">
                                    <label class="filter-col" for="nameselect">Filter by Name: </label>
                                    <select id="nameselect" class="form-control input-sm" multiple="multiple">
                                        <option value="141566">Abigail</option>
                                        <option value="141556">Annabelle</option>
                                        <option value="141557">Barnabus</option>
                                        <option value="141568">Bartholomew</option>
                                        <option value="141567">Cecilia</option>
                                        <option value="141558">Chester</option>
                                        <option value="141559">Daphne</option>
                                        <option value="141569">Derek</option>
                                        <option value="141560">Eleanor</option>
                                        <option value="141553">Finnigan</option>
                                        <option value="141554">George</option>
                                    </select>
                                </div> <!-- form group [rows] -->
                                <div class="form-group">
                                    <label class="filter-col" for="daterange">Filter by Date: </label>
                                    <input type="text" class="form-control input-sm" id="daterange" placeholder="Most Recent Points Shown">
                                </div><!-- form group [search] -->
                                <div class="form-group">
                                    <!--<div class="checkbox" style="margin-left:20px;">
                                        <label><input type="checkbox"> Show Track Lines</label>
                                    </div>-->
                                    <button id ='applyBtn' type="button" class="btn btn-default filter-col">
                                        <span class="glyphicon glyphicon-record"></span>    Apply
                                    </button>
                                    <button id = 'resetBtn' type="button" class="btn btn-default filter-col">
                                        <span class="glyphicon glyphicon-record"></span>    Reset Filters
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                </div>
             </div>
          <div id="mapViewDiv"></div>
      </div>
      <div id="3dTab" class="tab-pane fade" role="tabpanel">
        <div id="sceneViewDiv"></div>
      </div>
    </div>
  </div>

  <!-- Panel Container -->
<div class="calcite-panels calcite-text-light calcite-bg-dark calcite-black-75 panel-group" role="tablist" aria-multiselectable="true" style="z-index:2;">
    <div id="panelBasemaps" class="panel hidden">
      <div id="headingBasemaps" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle collapsed" role="button" data-toggle="collapse" href="#collapseBasemaps" aria-expanded="false"   aria-controls="collapseBasemaps"><span class="glyphicon glyphicon-th-large" aria-hidden="true"></span> Basemaps</a>
          <a class="panel-close" role="button" data-toggle="collapse" data-target="#panelBasemaps"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>
        </div>
      </div>
      <div id="collapseBasemaps" class="panel" role="tabpanel" aria-labelledby="headingBasemaps">
        <div class="panel-body">
          <select id="selectBasemapPanel" class="form-control" style="background-color:white;color:black">
            <option value="streets" data-vector="streets-vector">Streets</option>
            <option value="satellite" data-vector="satellite" selected="">Satellite</option>
            <option value="hybrid" data-vector="hybrid">Hybrid</option>
            <option value="national-geographic" data-vector="national-geographic">National Geographic</option>
            <option value="topo" data-vector="topo-vector">Topographic</option>
            <option value="gray" data-vector="gray-vector">Gray</option>
            <option value="dark-gray" data-vector="dark-gray-vector">Dark Gray</option>
            <option value="osm" data-vector="osm">Open Street Map</option>
            <option value="dark-gray" data-vector="streets-night-vector">Streets Night</option>
            <option value="streets" data-vector="streets-navigation-vector">Streets Mobile</option>
          </select>
        </div>
      </div>
    </div>
  </div> <!-- /.calcite-panels -->

  <!-- ArcGIS JS 4.0 -->
  <script src="http://js.arcgis.com/4.0/"></script>

  <script>
    var app;
    var startDate;
    var endDate;
    require(["esri/Map",
      "esri/Basemap",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/widgets/Search",
        "esri/layers/FeatureLayer",
            "esri/widgets/Popup",
		"esri/PopupTemplate",
            "esri/widgets/Legend",
      "esri/core/watchUtils",
      "dojo/query",
      "dojo/domReady!"
    ], function(Map, Basemap, MapView, SceneView, Search,FeatureLayer,Popup, PopupTemplate,Legend, watchUtils, query) {

        // App
        app = {
            scale: 50000000,
            center: [-111.95, 39.419],
            zoom: 5,
            initialExtent: null,
            basemap: "dark-gray",
            viewPadding: {
                bottom: 65
            },
            uiPadding: {
                top: 30, bottom: 15
            },
            mapView: null,
            sceneView: null,
            activeView: null,
            searchWidgetNav: null
        };
        // Map
        var map = new Map({
            basemap: app.basemap
        });
        app.mapView = new MapView({
            container: "mapViewDiv",
            map: map,
            zoom: app.zoom,
            center: app.center,
            padding: app.viewPadding,
            ui: {
                components: ["zoom", "compass"],
                padding: app.uiPadding
            },
            popup:{
                dockEnabled: true,
                dockOptions: {
                    buttonEnabled: true,
                    breakpoint:true,
                    position: 'top-center'
                }
            }
        });
        //app.mapView.zoom =6;
        var template = new PopupTemplate({
        title: "{ptt_id}",
        content: "Seen here on {Date_time}",
        fieldInfos: [{
			fieldName: "Date_time",
			label: "Date",
			format:{
                dateFormat: 'short-date-short-time'
            }
		  }, {
			fieldName: "ptt_id",
			label: "ID",
			visible: true
		  }
		  ]
		  });

        console.log(app.mapView.popup.ViewModel);

        var mrp = new FeatureLayer ({
            url: 'http://maps.dnr.utah.gov:6080/arcgis/rest/services/DWR/AWPE_Argos_Data_MRP/MapServer/0',
            outFields: ["*"],
            popupTemplate: template
        });
        var fl = new FeatureLayer({
            url: "http://maps.dnr.utah.gov:6080/arcgis/rest/services/DWR/AWPE_Argos_Data/MapServer/0",
            outFields: ["*"],
            popupTemplate: template
        });
        fl.load();
        map.add(mrp);
        var legend = new Legend({
            view: app.mapView,
            layerInfos: [{
                title: "Legend",
                layer: mrp
            }]
         });
        app.mapView.ui.add(legend, "bottom-left");
        // Scene
        var mapScene = new Map({
            basemap: app.basemap,
            ground: "world-elevation"
        });
        app.sceneView = new SceneView({
            container: "sceneViewDiv",
            map: mapScene,
            scale: app.scale,
            center: app.center,
            padding: app.viewPadding,
            ui: {
                padding: app.uiPadding
            }
        });
        app.activeView = app.mapView;
        app.activeView.then(function () {
            app.initialExtent = app.activeView.extent;
        });
        // Search



        app.searchWidgetNav = createSearchWidget("searchNavDiv");
        function createSearchWidget(parentId) {
            var search = new Search({
                viewModel: {
                    view: app.activeView,
                    highlightEnabled: false,
                    popupEnabled: true,
                    showPopupOnSelect: true
                }
            }, parentId);
            search.startup();
            return search;
        }

        // Popup Events
        app.mapView.popup.watch("currentDockPosition", function (result) {
            setPanelVisibility();
        });
        app.sceneView.popup.watch("currentDockPosition", function (result) {
            setPanelVisibility();
        });


        // Panel Events
        query(".calcite-panels .panel").on("show.bs.collapse", function (e) {
            if (app.activeView.popup.currentDockPosition) {
                app.activeView.popup.dockEnabled = false;
            }
        });
        // Window Events
        query(window).on("resize", function () {
            setPanelVisibility();
        })
        // Panel show/hide
        function setPanelVisibility() {
            if (app.activeView.popup.visible && app.activeView.popup.currentDockPosition && !(window.innerWidth > 544 && window.innerWidth < 768)) {
                if (query(".calcite-panels .panel.in").length > 0) {
                    query(".calcite-panels").addClass("invisible");
                } else {
                    query(".calcite-panels").removeClass("invisible");
                }
            } else {
                query(".calcite-panels").removeClass("invisible");
            }
        }

        // Tab Events (Views)
        query(".calcite-navbar li a[data-toggle='tab']").on("click", function (e) {
            syncTabs(e);
            if (e.target.text.indexOf("Map") > -1) {
                syncViews(app.sceneView, app.mapView);
                app.activeView = app.mapView;
            } else {
                syncViews(app.mapView, app.sceneView);
                app.activeView = app.sceneView;
            }
            syncSearch();
        });
        // Tab
        function syncTabs(e) {
            query(".calcite-navbar li.active").removeClass("active");
            query(e.target).addClass("active");
        }

        // View
        function syncViews(fromView, toView) {
            watchUtils.whenTrueOnce(toView, "ready").then(function (result) {
                watchUtils.whenTrueOnce(toView, "stationary").then(function (result) {
                    toView.goTo(fromView.viewpoint);
                    toView.popup.reposition();
                });
            });
        }

        // Search
        function syncSearch() {
            app.searchWidgetNav.viewModel.view = app.activeView;
            // Sync
            if (app.searchWidgetNav.selectedResult) {
                app.searchWidgetNav.search(app.searchWidgetNav.selectedResult.name);
            }
            app.activeView.popup.reposition();
        }

        // Basemap events
        query("#selectBasemapPanel").on("change", function (e) {
            app.mapView.map.basemap = e.target.options[e.target.selectedIndex].dataset.vector;
            app.sceneView.map.basemap = e.target.value;
        });
        // Collapsible popup (optional)
        query(".esri-popup .esri-title").on("click", function (e) {
            query(".esri-popup .esri-container").toggleClass("esri-popup-collapsed");
            app.activeView.popup.reposition();
        });
        // Home
        query(".calcite-navbar .navbar-brand").on("click", function (e) {
            app.activeView.goTo({target: app.initialExtent, rotation: 0});
        })


        $('#resetBtn').click(function (event) {
            event.preventDefault();
            $('#daterange').val('');
            $('#nameselect').multiselect("clearSelection");
            map.remove(fl);
            map.add(mrp);
        });



        $('li#filterNav2').click(function (event) {
            event.preventDefault();
            $('#filtercont').toggleClass('hidden show');
            $('#filterNav2').toggleClass('active');
        });
        $('li#basemapNav2').click(function (event) {
            event.preventDefault();
            $('#panelBasemaps').toggleClass('hidden show');
            $('#basemapNav2').toggleClass('active');
        });
        $('li#legendNav').click(function (event) {
            event.preventDefault();
            $('.esri-legend').toggleClass('hidden show');
            $('#legendNav').toggleClass('active');
        });

    $(
            document).ready(function() {
        $('#nameselect').multiselect({
            includeSelectAllOption: true,
            maxHeight: 400, dropUp:true
        });
        $("#nameselect").multiselect('selectAll', false);
        $("#nameselect").multiselect('updateButtonText');

        function cb(start, end) {
        $('#daterange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }
    cb(moment().subtract(29, 'days'), moment());

    $('#daterange').daterangepicker({
        "startDate": moment().subtract(6, 'days'),
        "endDate": moment(),
        autoUpdateInput: false,
        locale: {
          cancelLabel: 'Clear'
      },
        ranges: {
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        },
        "drops":"up",
        "opens":"center"
    },
        function(start, end, label) {
            console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label);
                startDate = start;
                endDate = end;
        }
    );

        /* $('#daterange').daterangepicker({
     autoUpdateInput: false,
            locale: {
          cancelLabel: 'Clear'
      },
            "showDropdowns": true,
    "timePicker": true,
    "autoApply": true,
    "ranges": {
        "Last 7 Days": [
            week,
            today
        ],
        "Last 30 Days": [
            month,
            today
        ],
        "Last Year": [
            year,
            today
        ],
        "Last Southern Migration": [
            new Date().setDate(today.getDate()-180),
            today
        ],
        "Last Northern Migration": [
            new Date().setDate(today.getDate()-365),
                today
        ]
    },
    "opens": "right",
            "drops":"up"
}, function(start, end, label) {
  console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label);
});*/

        $('#applyBtn').click(function (event) {
            event.preventDefault();
            map.remove(mrp);

            var selected = $('#nameselect option:selected').map(function (a, item) {
                return item.value;
            });
            if (selected.length > 0) {
                var nameListStr = "ptt_id IN (";
                for (var i = 0; i < selected.length; i++) {
                    if (i < selected.length - 1) {
                        nameListStr = nameListStr + "'" + selected[i] + "',";
                    }
                    else {
                        nameListStr = nameListStr + "'" + selected[i] + "')";
                    }
                }
            }
            else{
                nameListStr = "";
            }
            var dQuery;
            //console.log(startDate);
            if (typeof startDate !== "undefined") {
                var sDate = startDate.format('MM-DD-YYYY');
                var eDate = endDate.format('MM-DD-YYYY');
                dQuery = "Date_time <= date'"+eDate+"' AND Date_time >= date'"+sDate+"'";
            }
            else {
                dQuery = ""
            }
            if (nameListStr == ""){
                var query = dQuery
            }
            else{
                var query = dQuery + " AND "+ nameListStr;
            }
            //console.log(nameListStr);
            //var query = "ptt_id IN "+nameListStr;

            console.log(query);
            //dQuery = "Date_time <= date'06-16-2016' AND Date_time >= date'05-01-2016'";
            //console.log(dQuery);
            fl.definitionExpression = query;
            map.add(fl);
        });

        $(function() {
  $('#daterange').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format(
                      'MM/DD/YYYY') + ' - ' + picker.endDate.format(
                      'MM/DD/YYYY'));
  });

  $('#daterange').on('cancel.daterangepicker',
          function(ev, picker) {
      $(this).val('');
  });

});
        var drp = $('#daterange').data(
                'daterangepicker');
          console.log(drp.startDate_d);
    });

});

  </script>



</body>
</html>